<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<title>电子价签蓝牙传图控制器</title>
	<style>
		* {
			padding: 0;
			margin: 0;
			box-sizing: border-box;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		}
		
		body {
			padding: 20px;
			background-color: #f5f5f5;
			display: flex;
			flex-direction: column;
			height: 100vh;
			overflow: hidden;
			max-width: 800px; /* 限制最大宽度，使页面变窄 */
			margin: 0 auto; /* 居中显示 */
		}
		
		/* 顶部设备控制区域 */
		#device-control {
			background: white;
			border-radius: 8px;
			padding: 15px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			margin-bottom: 20px;
		}
		
		#device-control h1 {
			color: #333;
			font-size: 1.5rem;
			margin-bottom: 15px;
		}
		
		/* 中间图片处理区域 */
		#image-processing {
			background: white;
			border-radius: 8px;
			padding: 15px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			flex: 1;
			overflow-y: auto;
			margin-bottom: 20px;
		}
		
		/* 底部日志区域 */
		#log-area {
			background: white;
			border-radius: 8px;
			padding: 15px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			height: 30%;
			min-height: 200px;
			display: flex;
			flex-direction: column;
		}
		
		#log-area h2 {
			margin-bottom: 10px;
			flex-shrink: 0;
		}
		
		#log-container {
			flex: 1;
			overflow-y: auto;
		}
		
		button, select, input[type="file"], input[type="number"], input[type="text"] {
			padding: 6px 12px;
			margin: 5px;
			border: 1px solid #ddd;
			border-radius: 4px;
			cursor: pointer;
			font-size: 0.9rem;
		}
		
		button {
			background-color: #4CAF50;
			color: white;
			border: none;
			transition: background-color 0.3s;
		}
		
		button:hover {
			background-color: #45a049;
		}
		
		button.secondary {
			background-color: #2196F3;
		}
		
		button.secondary:hover {
			background-color: #0b7dda;
		}
		
		button.danger {
			background-color: #f44336;
		}
		
		button.danger:hover {
			background-color: #d32f2f;
		}
		
		h2, h3 {
			color: #444;
			margin: 10px 0;
			font-size: 1.2rem;
		}
		
		h3 {
			font-size: 1rem;
			color: #666;
			border-bottom: 1px solid #eee;
			padding-bottom: 5px;
			margin-top: 20px;
		}
		
		.control-group {
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			margin: 10px 0;
			padding: 10px;
			background-color: #f9f9f9;
			border-radius: 6px;
		}
		
		.control-group label {
			margin: 0 10px 0 0;
			color: #555;
		}
		
		#image-preview {
			/* 修改为上下布局 */
			display: flex;
			flex-direction: column;
			gap: 15px;
			margin: 15px 0;
			align-items: center; /* 居中对齐 */
		}
		
		.preview-container {
			/* 固定预览区大小 */
			width: 320px;
			height: 420px;
			text-align: center;
		}
		
		.preview-container h4 {
			margin-bottom: 8px;
			color: #666;
			font-size: 0.9rem;
		}
		
		canvas, .placeholder {
			border: 1px solid #ddd;
			border-radius: 4px;
			max-width: 100%;
			background-color: #f0f0f0;
			/* 固定画布大小 */
			width: 300px;
			height: 400px;
		}
		
		.placeholder {
			display: flex;
			align-items: center;
			justify-content: center;
			color: #999;
		}
		
		#log {
			width: 100%;
			height: 100%;
			border: 1px solid #ddd;
			border-radius: 4px;
			padding: 10px;
			overflow-y: auto;
			background-color: #f9f9f9;
			font-family: monospace;
			font-size: 0.9rem;
			line-height: 1.4;
		}
		
		.size-options {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			margin: 10px 0;
		}
		
		.size-option {
			padding: 5px 10px;
			border: 1px solid #ddd;
			border-radius: 4px;
			cursor: pointer;
			font-size: 0.8rem;
		}
		
		.size-option.selected {
			background-color: #4CAF50;
			color: white;
			border-color: #4CAF50;
		}
		
		.log-time {
			color: #666;
		}
		
		.log-message {
			color: #333;
		}
		
		.action-buttons {
			margin-top: 20px;
			text-align: center;
		}
		
		.action-buttons button {
			padding: 8px 20px;
			font-size: 1rem;
		}

		.rotation-controls {
			margin: 15px 0;
			padding: 10px;
			background-color: #f5f5f5;
			border-radius: 5px;
		}

		.rotation-buttons {
			display: flex;
			gap: 10px;
			margin-top: 8px;
			justify-content: center; /* 居中显示旋转按钮 */
		}

		.rotation-control {
			padding: 6px 12px;
			border: 1px solid #ccc;
			border-radius: 4px;
			background-color: white;
			cursor: pointer;
		}

		.rotation-control.selected {
			background-color: #007bff;
			color: white;
			border-color: #007bff;
		}

		/* 旋转容器样式 */
		.rotating-container {
			transition: transform 0.3s ease;
			display: inline-block;
		}

		/* 文本输入区域样式 - 默认隐藏 */
		.text-input-group {
			margin: 15px 0;
			padding: 15px;
			background-color: #f5f5f5;
			border-radius: 5px;
			display: none; /* 默认隐藏 */
		}
		.text-controls {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
			align-items: center;
			margin-top: 8px;
		}
		#text-input {
			flex-grow: 1;
			padding: 6px 10px;
			min-width: 200px;
		}
		.font-size-control, .font-family-control {
			display: flex;
			align-items: center;
			gap: 5px;
		}
		.color-option {
			width: 20px;
			height: 20px;
			border-radius: 3px;
			cursor: pointer;
			border: 2px solid transparent;
		}
		.color-option.selected {
			border-color: #333;
		}

		/* 文字拖拽相关样式 */
		.text-drag-hint {
			font-size: 0.8rem;
			color: #666;
			margin-top: 5px;
			text-align: center;
		}
		.dragging-cursor {
			cursor: move;
		}
	</style>
</head>

<body>
	<!-- 顶部设备控制区域 -->
	<div id="device-control">
		<h1>电子价签蓝牙传图控制器</h1>
		<div class="control-group">
			<label>蓝牙设备筛选:</label>
			<select id="device-filter">
				<option value="nrf" selected>仅NRF开头设备</option>
				<option value="all">所有设备</option>
			</select>
			
			<button id="connectbutton" class="secondary" onclick="preConnect();">搜索并连接</button>
			<button id="disconnectbutton" class="danger" onclick="disconnect();" style="display:none;">断开连接</button>
			<button onclick="reConnect();" class="secondary">重新连接</button>
			<button onclick="document.getElementById('log').innerHTML = '';" class="danger">清空日志</button>
		</div>
	</div>

	<!-- 中间图片处理区域 -->
	<div id="image-processing">
		<h2>图片处理与上传</h2>
		
		<div class="control-group">
			<label>选择图片:</label>
			<input type="file" id="image_file" onchange="update_image()" accept=".png,.jpg,.bmp,.webp,.jpeg">
			<button onclick="update_image()" class="secondary">重新加载</button>
			<button onclick="clear_canvas()" class="danger">清空画布</button>
			<button onclick="toggleTextMode()" class="secondary">文本模式</button> <!-- 添加文本模式按钮 -->
		</div>
		
		<!-- 文本输入区域 -->
		<div class="text-input-group" id="textInputGroup">
			<h4>添加文本（可拖拽调整位置）</h4>
			<div class="text-controls">
				<input type="text" id="text-input" placeholder="输入要添加的文字...">
				<div class="font-family-control">
					<label>字体:</label>
					<select id="font-family">
						<option value="Arial" selected>Arial (无衬线)</option>
						<option value="SimSun">宋体 (中文字体)</option>
						<option value="Microsoft YaHei">微软雅黑 (中文字体)</option>
						<option value="Courier New">Courier New (等宽)</option>
						<option value="Georgia">Georgia (衬线)</option>
					</select>
				</div>
				<div class="font-size-control">
					<label>字体大小:</label>
					<input type="number" id="font-size" value="24" min="8" max="100">
				</div>
				<div>
					<label>颜色:</label>
					<div class="color-options">
						<div class="color-option selected" data-color="black" style="background-color: black;"></div>
						<div class="color-option" data-color="white" style="background-color: white;"></div>
						<div class="color-option" data-color="red" style="background-color: red;"></div>
					</div>
				</div>
				<button onclick="addTextToCanvas()" class="secondary">添加到画布</button>
			</div>
			
			<div class="text-drag-hint">提示：点击添加的文字可拖拽调整位置，文字会随图片一起旋转</div>
		</div>
		
		<div class="control-group">
			<label>墨水屏尺寸:</label>
			<div class="size-options">
				<div class="size-option" data-width="250" data-height="128">250x128 (2.13英寸)</div>
				<div class="size-option" data-width="296" data-height="128">296x128 (2.9英寸)</div>
				<div class="size-option" data-width="296" data-height="152">296x152 (2.6英寸)</div>
				<div class="size-option selected" data-width="300" data-height="400">300x400(4.2英寸) (默认)</div>
			</div>
		</div>
		
		<div class="control-group">
			<label>图片处理算法:</label>
			<select id="dithering" title="抖动算法">
				<optgroup label="黑白">
					<option value="none">二值化</option>
					<option value="bayer">bayer</option>
					<option value="floydsteinberg">floydsteinberg</option>
					<option value="Atkinson">Atkinson</option>
				</optgroup>
				<optgroup label="黑白红多色">
					<option value="bwr_floydsteinberg">黑白红floydsteinberg</option>
					<option value="bwr_Atkinson" selected>黑白红Atkinson</option>
				</optgroup>
			</select>
			
			<label>阈值:</label>
			<input type="number" max="255" min="0" value="125" id="threshold">
			
			<button onclick="convert_dithering()" class="secondary">应用处理</button>
		</div>
		
		<div id="image-preview">
			<div class="preview-container">
				<h4>原始图片</h4>
				<div id="original-preview" class="placeholder">请上传图片</div>
			</div>
			<div class="preview-container">
				<h4>处理后图片 (可拖拽文字调整位置)</h4>
				<div class="rotating-container" id="processed-rotating-container">
					<canvas id="processed-preview" width="300" height="400" style="display: none;"></canvas>
					<div id="processed-placeholder" class="placeholder">处理后的图片将显示在这里</div>
				</div>
			</div>
		</div>
		
		<div class="rotation-controls">
			<h4>图片旋转（文字将同步旋转）</h4>
			<div class="rotation-buttons">
				<button class="rotation-control selected" data-angle="0">0°</button>
				<button class="rotation-control" data-angle="90">90°</button>
				<button class="rotation-control" data-angle="180">180°</button>
				<button class="rotation-control" data-angle="270">270°</button>
			</div>
		</div>
		
		<div class="action-buttons">
			<button onclick="upload_image()" style="font-weight: bold; background-color: #4CAF50;">上传到电子价签</button>
		</div>
		
		<!-- 隐藏的主画布 -->
		<canvas id="canvas" width="300" height="400" style="display: none;"></canvas>
	</div>

	<!-- 底部日志区域 -->
	<div id="log-area">
		<h2>操作日志</h2>
		<div id="log-container">
			<div id="log"></div>
		</div>
	</div>

	<script src="epaper.js"></script>
	<script>
		// 添加文本模式切换功能
		function toggleTextMode() {
			const textInputGroup = document.getElementById('textInputGroup');
			textInputGroup.style.display = textInputGroup.style.display === 'none' ? 'block' : 'none';
		}
	</script>
</body>
</html>